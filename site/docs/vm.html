<!doctype html>
<html>

<head>
    <meta charset="utf-8"/>
    <title>Wheel - VM</title>

    <base href="../../">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans:300" rel="stylesheet">
    <link href="css/wheel.css" rel="stylesheet">

    <script src="js/utils/syntax.js"></script>
</head>

<body>
    <div class="header">
        <div class="container">
            <ul>
                <li class="wheel"><a href="index.html">Wheel</a></li>
                <li><a href="site/examples/index.html">Examples</a></li>
                <li><a href="site/docs/index.html" class="active">Documentation</a></li>
                <li><a href="site/modules/index.html">Modules</a></li>
                <li><a href="site/simulator/index.html">Simulator</a></li>
            </ul>
            <a href="https://github.com/ArnoVanDerVegt/wheel" class="download">
                <span>Download</span><img src="site/images/github.svg"/>
            </a>
        </div>
    </div>

    <div class="sub-header">
        <div class="container">
            <img src="site/images/vm.png" class="header-image"/>
            <h1>Documentation</h1>
            <h2>A text based language to run in an EV3 block.</h2>
        </div>
    </div>

    <div class="content">
        <div class="container">
            <div class="three last right">
                <h3 class="purple with-icon"><img src="site/images/icons/play.png" width="32" height="32"/> <span>VM</span></h3>

                <h3 class="dark-blue margin-top margin-bottom">Documentation</h3>
                <div class="index">
                    <a href="site/docs/about.html">About Wheel</a><br />
                    <a href="site/docs/setupguide.html">Setup guide</a><br />
                    <a href="site/docs/roadmap.html">Roadmap</a><br />
                    <a href="site/docs/syntax.html">Syntax</a><br />
                    <a href="site/docs/variables.html">Variables</a><br />
                    <a href="site/docs/loops.html">Loops</a><br />
                    <a href="site/docs/conditions.html">Conditions</a><br />
                    <a href="site/docs/procedures.html">Procedures</a><br />
                    <a href="site/docs/compiler.html">Compiler</a><br />
                    <a href="site/docs/vm.html" class="active">VM</a><br />
                    <a href="site/docs/modules.html">Modules</a><br />
                    <a href="site/docs/fileformat.html">File format</a><br />
                    <a href="site/docs/errors.html">Compiler errors</a><br />
                </div>

                <h3 class="dark-blue">VM</h3>
                <ul class="last">
                    <li><a href="site/docs/vm.html#data">Data</a></li>
                    <li><a href="site/docs/vm.html#commands">Commands</a></li>
                    <li><a href="site/docs/vm.html#registers">Registers</a></li>
                    <li><a href="site/docs/vm.html#callstack">Call stack</a></li>
                </ul>
            </div>

            <div class="two first" id="data">
                <h4>VM</h4>
                <h5>Data</h5>
                There is only one data type: <i>number</i>. Strings are handled as number references.<br/>
                <br/>
                The memory is a single list of numbers. The first part of the memory is used for globals,
                the second is used as call stack for parameter and local variables.<br/>
            </div>

            <div class="two first" id="commands">
                <h5>Commands</h5>

                Since the virtual machine had to be implemented in the EV3 software it should be as simple as possible.
                The VM uses only 10 commands:<br/>
                <br/>

                <table>
                    <tr>
                        <th>#</th>
                        <th>Command</th>
                        <th>Parameters</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td>0</td>
                        <td>copy</td>
                        <td>size</td>
                        <td>Copy <i>size</i> from <i>src</i> to <i>dest</i>.
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>jmpc</td>
                        <td>offset, flag</td>
                        <td>Set <i>code</i> if the given flag is true.</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>cmp</td>
                        <td>a, b</td>
                        <td>Compare <i>a</i> with <i>b</i> and set flags.</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>module</td>
                        <td>moduleId, procId</td>
                        <td>Call the procedure <i>procId</i> of module <i>module</i>.</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>set</td>
                        <td>var, value</td>
                        <td>Set <i>var</i> to <i>value</i>.</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>add</td>
                        <td>var, value</td>
                        <td>Add <i>value</i> to <i>var</i>.</td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td>sub</td>
                        <td>var, value</td>
                        <td>Subtract <i>value</i> to <i>var</i>.</td>
                    </tr>
                    <tr>
                        <td>7</td>
                        <td>mul</td>
                        <td>var, value</td>
                        <td>Multiply <i>value</i> to <i>var</i>.</td>
                    </tr>
                    <tr>
                        <td>8</td>
                        <td>div</td>
                        <td>var, value</td>
                        <td>Divide <i>value</i> to <i>var</i>.</td>
                    </tr>
                    <tr>
                        <td>9</td>
                        <td>mod</td>
                        <td>var, value</td>
                        <td>Module <i>var</i> with <i>value</i>.</td>
                    </tr>
                </table>
                <br/>

                <h6>copy</h6>
                Copy <i>size</i> values from the <i>src</i> pointer to the <i>dest</i> pointer.<br/>
                <pre>
                    copy 10 ; copy 10 numbers from src to dest
                </pre>

                <h6>jmpc</h6>
                Conditional jump, based on the flag paramer.<br/>
                The flags are set with the <i>cmp</i> command.<br/>
                <br/>

                <table>
                    <tr>
                        <th>Flag</th>
                        <th>Value</th>
                    </tr>
                    <tr>
                        <td>Equal</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>Not equal</td>
                        <td>2</td>
                    </tr>
                    <tr>
                        <td>Less</td>
                        <td>4</td>
                    </tr>
                    <tr>
                        <td>Less equal</td>
                        <td>8</td>
                    </tr>
                    <tr>
                        <td>Greater</td>
                        <td>16</td>
                    </tr>
                    <tr>
                        <td>Greater equal</td>
                        <td>32</td>
                    </tr>
                </table>

                <pre>
                    jmpc 45, 1 ; Jump to 45 if equal...
                </pre>

                <h6>cmp</h6>
                Compare one value to another and set the flags.<br/>
                <pre>
                    cmp a, 3 ; Compare a with 3...
                </pre>

                <h6>module</h6>
                Call a module procedure.<br/>
                <pre>
                    module 1, 5 ; Call procudure 5 from module 1
                </pre>

                <h6>set</h6>
                Set the value of a variable.<br/>
                <pre>
                    set var, n ; var = n
                </pre>

                <h6>add, sub, mul, div, mod</h6>
                These operators change the value of <i>var</i> by applying the value of <i>n</i>.<br/>
                <pre>
                    add var, n ; var = var + n
                    sub var, n ; var = var - n
                    mul var, n ; var = var * n
                    div var, n ; var = var / n
                    mod var, n ; var = var % n
                </pre>
            </div>

            <div class="two first" id="registers">
                <h5>Registers</h5>
                The VM uses 6 registers: <i>stack</i>, <i>src</i>, <i>dest</i>, <i>code</i>, <i>return</i> and <i>flags</i>.<br/>
                <br/>
                A register in the Wheel VM is basicaly a reserved memory address with a special purpose. The first (<i>stack</i>)
                register is located at offset 0, the last (<i>flags</i>) is located at offset 5.<br/>
                <br/>
                <table>
                    <tr>
                        <th>Offset</th>
                        <th>Register</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td>0</td>
                        <td>stack</td>
                        <td>Stack pointer.</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>src</td>
                        <td>Source pointer for copy command/general purpose.</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>dest</td>
                        <td>Destination pointer for copy command/general purpose.</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>code</td>
                        <td>Code execution offset.</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>return</td>
                        <td>Function return value.</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>flags</td>
                        <td>Compater flags, unused in EV3 VM.</td>
                    </tr>
                </table>
                <br/>
                The <i>stack</i> register points to the top of the stack and is increased when a call is made. The <i>src</i> and <i>dest</i>
                are used in combibation with the <i>copy</i> command and are also used as general purpose registers. The <i>code</i> register
                contains the pointer to the current execution position. The <i>return</i> register is used to return a value from a function
                call.<br/>
                <br/>
                <h6>The <i>code</i> register</h6>
                After each command which is executed the value of the <i>code</i> register is increased with 1.
                When a call is executed then the offset of the <i>code</i> register is set to the procedure offset minus 1, since the
                value will be increased immediately after setting it.
            </div>

            <div class="two first" id="callstack">
                <h5>Call stack</h5>
                The VM does not have a call command. A call is made by changing the value of the <i>code</i> register.
                The following table shows the local memory layout in a procedure, these values are relative to the <i>stack</i>
                pointer.<br/>
                <br/>
                <table>
                    <tr>
                        <th>Offset</th>
                        <th>Size</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td>0</td>
                        <td>1</td>
                        <td>Caller stack pointer</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>1</td>
                        <td>Code return pointer</td>
                    </tr>
                    <tr>
                        <td>2..2 + paramSize</td>
                        <td>paramSize</td>
                        <td>Parameter values</td>
                    </tr>
                    <tr>
                        <td>2 + paramSize..2 + paramSize + localSize</td>
                        <td>localSize</td>
                        <td>Local values</td>
                    </tr>
                </table>
                <br/>
                The total memory use of a procudure is equal to the sum of the parameter variables size,
                the local variables size and 2 numbers for the stack and code return values.<br/>
                <br/>
                When a call is made the value of the stack pointer will be increased with the size of
                the local data, the sum of the sizes in the table.<br/>
                <br/>
                The following example shows how the call to <i>drawCircle</i> is compiled.<br/>
                <pre>
                    #include "lib/screen.whl"

                    proc main()
                        drawCircle(109, 64, 15)
                    end
                </pre>

                Which results in the following code:<br/>
                <pre>
                    01: set    [stack+0004],  109
                    02: set    [stack+0005],  64
                    03: set    [stack+0006],  15
                    04: set    dest,          code
                    05: add    dest,          6
                    06: set    src,           stack
                    07: add    stack,         2
                    08: set    [stack+0000],  src
                    09: set    [stack+0001],  dest
                    10: set    code,          70
                </pre>

                &nbsp;<br/>

                <ul class="clear">
                    <li>
                        On lines 1, 2 and 3 parameter values are set.
                        The offset of the first parameter is equal to the local stack
                        size + 2. The local stack size is 2, a stack and code return value.<br/>
                    </li>
                    <li>
                        On lines 4 and 5 the <i>code</i> value is moved to the <i>dest</i> register and
                        6 is added for the folliwing 6 commands.<br/>
                        The call is made from the main function which does not have local or parameter values,
                        otherwise the size of the parameter and local variables should be added to the offset.<br/>
                    </li>
                    <li>
                        At line 6 the <i>stack</i> value is saved in the <i>src</i> register.<br/>
                    </li>
                    <li>
                        At line 7 the <i>stack</i> pointer is increased with the size of the current local size.<br/>
                    </li>
                    <li>
                        At line 8 the stack pointer is stored on the stack, the value of the stack pointer was copied to the
                        <i>src</i> register at line 6.<br/>
                    </li>
                    <li>
                        At line 9 the code return value is stored on the stack, the value of the code pointer was
                        calculated in lines 4 and 5 and was stored in <i>dest</i>.
                    </li>
                    <li>
                        At line 10 the jump is executed by assinging a new value to the <i>code</i> register.
                    </li>
                </ul>
            </div>

            <div style="float:left;clear:both;"></div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="links-wrapper">
                <div class="links">
                    <a href="site/license.html">License</a>
                    <a href="site/disclaimer.html">Disclaimer</a>
                </div>
            </div>
            <span class="copyright">Copyright Ⓒ 2017 Arno van der Vegt</span>
            <a href="https://www.codacy.com/app/ArnoVanDerVegt/wheel?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=ArnoVanDerVegt/wheel&amp;utm_campaign=Badge_Grade"><img src="https://api.codacy.com/project/badge/Grade/4466f90ab2274801b7b088c8f661e6a3" class="badge"/></a>
            <img src="https://api.travis-ci.org/ArnoVanDerVegt/wheel.svg?branch=master" class="badge"/>
        </div>
    </div>
</body>

</html>